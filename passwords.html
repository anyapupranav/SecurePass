<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecurePass - Passwords</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            transition: background-color 0.3s, color 0.3s;
        }

        .password-card {
            border-radius: 12px;
            padding: 15px;
            background: #ffffff;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            transition: background 0.3s;
        }

        #sharePasswordBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            /* darker background */
            z-index: 1048;
            /* below modal z-index (1050) */
            display: none;
        }

        .btn-primary {
            background-color: #e67e22;
            border: none;
        }

        .footer {
            background-color: #f4e1c6;
            text-align: center;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .modal-content {
            background-color: #ffffff;
        }

        .modal-Text {
            color: rgb(0, 0, 0);
        }

        .close {
            color: rgb(0, 0, 0);
        }

        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .dark-mode .password-card {
            background: #1e1e1e;
            color: white;
        }

        .dark-mode .footer {
            background-color: #333;
        }

        .dark-mode .modal-content {
            background-color: #1e1e1e;
        }

        .dark-mode .modal-Text {
            color: rgb(255, 255, 255);
        }

        .dark-mode .close {
            color: rgb(255, 255, 255);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light p-3">
        <a class="navbar-brand font-weight-bold" href="dashboard.html">ðŸ”’ SecurePass</a>
        <input type="text" id="searchInput" class="form-control w-25" placeholder="Search passwords..."
            onkeyup="searchPasswords()">
        <button id="darkModeToggle" class="toggle-btn">
            <i class="fas fa-moon"></i>
        </button>
    </nav>

    <div class="container mt-4">
        <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#addPasswordModal">Add New
            Password</button>

        <!-- Filter Button -->
        <div class="mb-3">
            <select id="filterGroup" class="form-control w-25 d-inline-block">
                <!-- Groups -->
                <option value="all">All Groups</option>
            </select>
            <button class="btn btn-primary" onclick="filterPasswords()">Filter</button>
        </div>

        <div class="passwords" id="passwords">
            <!-- Password Cards -->
        </div>
        <br></br>

    </div>

    <div class="footer">SecurePass Â© 2025</div>

    <!-- Show passwords modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                    <div class="viewAccountPassword" id="viewAccountPassword">

                        <h5 class="text-center"> View Password </h5>

                        <div id="editAccountPasswordInfoMessage" class="alert alert-dismissible fade show"
                            style="display: none;"> </div>
                        <div id="deleteAccountPasswordInfoMessage" class="alert alert-dismissible fade show"
                            style="display: none;"> </div>

                        <div class="form-group">
                            <label for="viewAccountPasswordGroup">Group</label>
                            <input type="text" class="form-control" id="viewAccountPasswordGroupValue" disabled>
                        </div>
                        <div class="form-group">
                            <label for="viewAccountPasswordAccountName"> Account Name </label>
                            <input type="text" class="form-control" id="viewAccountPasswordAccountName" disabled>
                        </div>
                        <div class="form-group">
                            <label for="viewAccountPasswordUsername">Username</label>
                            <input type="text" class="form-control" id="viewAccountPasswordUsername" disabled>
                        </div>
                        <input type="hidden" id="viewAccountPasswordId" name="viewAccountPasswordId">
                        <div class="form-group">
                            <label for="viewAccountPasswordPassword">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="viewAccountPasswordPassword" disabled>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button"
                                        id="togglePasswordForView"><i class="fas fa-eye"></i></button>
                                </div>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="copyPassword"><i
                                            class="far fa-clone"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="viewAccountPasswordUrl">URL</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="viewAccountPasswordUrl" disabled>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="launchUrl"><i
                                            class="fas fa-share	"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="viewAccountPasswordNotes">Notes</label>
                            <textarea class="form-control" id="viewAccountPasswordNotes" disabled></textarea>
                        </div>
                    </div>

                    <div class="editAccountPassword" id="editAccountPassword" style="display:none;">

                        <h5 class="text-center"> Edit Password </h5>

                        <div class="form-group">
                            <label for="group">Group</label>
                            <select id="group" class="form-control">
                                <!-- Groups -->
                                <option value="new">Add New Group</option>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="newGroup"
                                placeholder="Enter new group name">
                        </div>
                        <div class="form-group">
                            <label for="editAccountPasswordAccountName"> Account Name </label>
                            <input type="text" class="form-control" id="editAccountPasswordAccountName">
                        </div>
                        <div class="form-group">
                            <label for="editAccountPasswordUsername">Username</label>
                            <input type="text" class="form-control" id="editAccountPasswordUsername">
                        </div>
                        <input type="hidden" id="editAccountPasswordId" name="editAccountPasswordId">
                        <div class="form-group">
                            <label for="editAccountPasswordPassword">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="editAccountPasswordPassword">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button"
                                        id="togglePasswordForEdit"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-outline-secondary" type="button"
                                        id="toggleGeneratePasswordForEdit"><i class="fa-solid fa-key"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editAccountPasswordUrl">URL</label>
                            <input type="text" class="form-control" id="editAccountPasswordUrl">
                        </div>
                        <div class="form-group">
                            <label for="editAccountPasswordNotes">Notes</label>
                            <textarea class="form-control" id="editAccountPasswordNotes"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="editAccountPasswordBtn">Edit</button>
                    <button class="btn btn-success" id="saveAccountPasswordBtn" style="display:none;">Save</button>
                    <button class="btn btn-danger" id="deleteAccountPasswordBtn">Delete</button>
                    <button class="btn btn-info float-right" id="shareAccountPasswordToggleBtn" data-toggle="modal"
                        data-target="#sharePasswordModal">Share</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add Password Modal -->
    <div class="modal fade" id="addPasswordModal" tabindex="-1" role="dialog" aria-labelledby="addPasswordModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                    <div class="addNewAccountPassword" id="addNewAccountPassword">

                        <h5 class="text-center"> Add New Password </h5>

                        <div id="addNewAccountPasswordInfoMessage" class="alert alert-dismissible fade show"> </div>

                        <div class="form-group">
                            <label for="addNewGroup">Group</label>
                            <select id="addNewGroup" class="form-control">
                                <option selected="" disabled="">--- Select Group ---</option>
                                <!-- Groups -->
                                <option value="new">Add New Group</option>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="addNewGroupCreate"
                                placeholder="Enter new group name">
                        </div>
                        <div class="form-group">
                            <label for="addNewAccountName"> Account Name </label>
                            <input type="text" class="form-control" id="addNewAccountName" required>
                        </div>
                        <div class="form-group">
                            <label for="addNewUsername">Username</label>
                            <input type="text" class="form-control" id="addNewUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="addNewPassword">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="addNewPassword" required>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button"
                                        id="togglePasswordForAddNewPassword"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-outline-secondary" type="button"
                                        id="toggleGeneratePasswordForAddNewPassword"><i
                                            class="fa-solid fa-key"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addNewPasswordUrl">URL</label>
                            <input type="text" class="form-control" id="addNewPasswordUrl" placeholder="Enter URL">
                        </div>
                        <div class="form-group">
                            <label for="addNewPasswordNotes">Notes</label>
                            <textarea class="form-control" id="addNewPasswordNotes"
                                placeholder="Enter notes"></textarea>
                        </div>
                    </div>
                    <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button id="addNewPasswordBtn" class="btn btn-primary">Add Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Generator Modal -->
    <div class="modal fade" id="passwordGeneratorModal" tabindex="-1" role="dialog"
        aria-labelledby="passwordGeneratorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Password Generator</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <form id="passwordForm">
                        <!-- Toggle Password / Passphrase -->
                        <div class="btn-group btn-group-toggle d-flex mb-3" data-toggle="buttons">
                            <label class="btn btn-outline-primary active w-50">
                                <input type="radio" name="mode" id="togglePassword" autocomplete="off" checked> Generate
                                Password
                            </label>
                            <label class="btn btn-outline-primary w-50">
                                <input type="radio" name="mode" id="togglePassphrase" autocomplete="off"> Generate
                                Passphrase
                            </label>
                        </div>

                        <!-- Password Parameters -->
                        <div id="passwordParameters">
                            <div class="form-group">
                                <label>Password Length:</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <button type="button" class="btn btn-outline-secondary"
                                            id="decrementLength">-</button>
                                    </div>
                                    <input type="range" class="form-control" id="length" min="6" max="255" value="16">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary"
                                            id="incrementLength">+</button>
                                    </div>
                                </div>
                                <input type="number" class="form-control mt-2" id="lengthText" value="16">
                            </div>
                            <div class="form-group d-flex flex-wrap">
                                <div class="btn btn-outline-secondary m-1 toggle-option">
                                    <input type="checkbox" id="uppercase" class="d-none"> Uppercase
                                </div>
                                <div class="btn btn-outline-secondary m-1 toggle-option active">
                                    <input type="checkbox" id="lowercase" class="d-none" checked> Lowercase
                                </div>
                                <div class="btn btn-outline-secondary m-1 toggle-option active">
                                    <input type="checkbox" id="numbers" class="d-none" checked> Numbers
                                </div>
                                <div class="btn btn-outline-secondary m-1 toggle-option">
                                    <input type="checkbox" id="special" class="d-none"> Special
                                </div>
                            </div>
                        </div>

                        <!-- Passphrase Parameters -->
                        <div id="passphraseParameters" style="display: none;">
                            <div class="form-group">
                                <label>Number of Words:</label>
                                <input type="number" class="form-control" id="words" min="1" max="100" value="5">
                            </div>
                            <div class="form-group d-flex flex-wrap">
                                <div class="btn btn-outline-secondary m-1 toggle-option">
                                    <input type="checkbox" id="includeNumbers" class="d-none"> Include Numbers
                                </div>
                                <div class="btn btn-outline-secondary m-1 toggle-option">
                                    <input type="checkbox" id="capitalize" class="d-none"> Capitalize Words
                                </div>
                                <div class="btn btn-outline-secondary m-1 toggle-option active">
                                    <input type="checkbox" id="separator" class="d-none" checked> Include Separator
                                </div>
                            </div>
                        </div>

                        <!-- Output -->
                        <div class="form-group">
                            <label>Generated Output:</label>
                            <input type="text" class="form-control text-center" id="password" readonly>
                        </div>

                        <!-- Buttons -->
                        <div class="text-center">
                            <button type="button" class="btn btn-primary" id="generateButton">Generate</button>
                            <button type="button" class="btn btn-success ml-2" id="usePasswordButton" disabled>Use this
                                Password</button>
                            <button type="button" class="btn btn-secondary ml-2" id="copyToClipboardButton"
                                data-clipboard-target="#password" disabled>Copy</button>
                        </div>

                        <div id="message" class="text-danger mt-2 text-center"></div>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <!-- Share Password Modal -->
    <div class="modal fade" id="sharePasswordModal" tabindex="-1" role="dialog"
        aria-labelledby="sharePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
            <div class="modal-content p-3">
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                    <h5 class="text-center mb-3">Share Account/Password</h5>

                    <!-- Internal Sharing -->
                    <div class="form-group">
                        <input type="hidden" id="sharePasswordId">
                        <label for="internalEmail">Share with Internal User (Email)</label>
                        <input type="email" class="form-control" id="internalEmail" placeholder="Enter user email...">
                        <small id="emailCheckMessage" class="form-text mt-1"></small>
                        <button id="shareInternalBtn" class="btn btn-sm btn-primary mt-2" onclick="shareInternally()"
                            disabled>Share Internally</button>
                    </div>

                    <hr>

                    <!-- External Sharing -->
                    <div class="form-group">
                        <label>External Share</label><br>
                        <button class="btn btn-sm btn-secondary" onclick="toggleExternalShareFields()">Generate External
                            Link</button>

                        <div id="externalShareFields" style="display:none;" class="mt-3">
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="noExpiryCheckbox">
                                <label class="form-check-label" for="noExpiryCheckbox">No Expiry</label>
                            </div>

                            <div id="expiryFields">
                                <label>Expiry Date</label>
                                <input type="date" class="form-control" id="expiryDate">
                                <label class="mt-2">Expiry Time</label>
                                <input type="time" class="form-control" id="expiryTime">
                            </div>

                            <button class="btn btn-sm btn-success mt-2" onclick="shareExternally()">Create Link</button>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="externalShareLink" readonly
                                    style="display:none;">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="copyExternalLink"
                                        style="display:none;">Copy URL</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-secondary mt-3" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spinner Overlay -->
    <div id="spinnerOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:9999; text-align:center;">
        <div class="spinner-border text-primary" role="status" style="margin-top:20%;">
            <span class="sr-only">Loading...</span>
        </div>
    </div>


    <script src="darkmode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>

    <script>

        $(document).ready(function () {
            // Show spinner on any AJAX start
            $(document).ajaxStart(function () {
                $('#spinnerOverlay').show();
            });

            // Hide spinner when all AJAX calls are done
            $(document).ajaxStop(function () {
                $('#spinnerOverlay').hide();
            });
        });

        // Show spinner
        $('#spinnerOverlay').show();

        var passwordData = { data: [] }; // Global object to store password data

        // send request to check sessions
        $(document).ready(function () {
            $.ajax({
                url: "API/check_and_maintain_session_and_cookies.php",
                method: "POST",
                dataType: "json",
                success: function (response) {
                    if (response.message === "not_logged_in") {
                        window.location.href = "login.html";
                    }
                    else {
                        fetch('API/fetch_password.php')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {

                                    // Log event to Database
                                    $.ajax({
                                        url: 'API/log_event.php',
                                        type: 'POST',
                                        data: {
                                            action: 'PAGE_VISIT',
                                            details: 'Visited Passwords Page'
                                        }
                                    });

                                    passwordData.data = data.data;
                                    console.log("Data received:", passwordData.data);
                                    let myPasswordsDiv = document.getElementById("passwords");
                                    let selectGroupElement = document.getElementById("filterGroup");
                                    let addPasswordGroupElement = document.getElementById("group");
                                    let addNewAccountGroupElement = document.getElementById("addNewGroup");

                                    let uniqueGroups = [...new Set(passwordData.data.map(row => row.GroupName))];

                                    uniqueGroups.forEach(GroupName => {
                                        let selectHTML = `
                                                        <option value="${GroupName}">${GroupName}</option>
                                                    `;

                                        // Append card to the div
                                        selectGroupElement.innerHTML += selectHTML;

                                        let selectGroupHTML = `
                                                        <option value="${GroupName}">${GroupName}</option>
                                                    `;

                                        // Append card to the div
                                        addPasswordGroupElement.innerHTML += selectGroupHTML;

                                        let selectGroupForAddNewAccountHTML = `
                                                        <option value="${GroupName}">${GroupName}</option>
                                                    `;

                                        // Append card to the div
                                        addNewAccountGroupElement.innerHTML += selectGroupForAddNewAccountHTML;
                                    });

                                    data.data.forEach(row => {

                                        if (row.IsAccountShared == 1) {
                                            var ShareIcon = '<span class="d-inline-block" tabindex="0" data-toggle="SharePopover" data-placement="top"  data-content="You are sharing this account with others.">&nbsp&nbsp<i class="fa-solid fa-users"></i></span>';
                                        }
                                        else {
                                            var ShareIcon = '';
                                        }
                                        let cardHTML = `
                                                        <div class="password-card p-3 mb-3" 
                                                            data-uuid="${row.ID}"
                                                            data-group="${row.GroupName}" 
                                                            data-website="${row.AppName}" 
                                                            data-username="${row.UserName}" 
                                                            data-password="${row.Password}" 
                                                            data-websiteurl="${row.WebsiteUrl}" 
                                                            data-notes="${row.Notes}">
                                                            
                                                            <h5 class="password-Appname-title"><b>${row.AppName}</b>
                                                                ${ShareIcon}
                                                            </h5>
                                                            <p class="text-muted password-account-username">User Name: ${row.UserName}</p>
                                                        </div>
                                                    `;

                                        // Append card to the div
                                        myPasswordsDiv.innerHTML += cardHTML;

                                        // Show data if password card is clicked
                                        $(document).ready(function () {
                                            $('.password-card').click(function () {
                                                // Get data from the clicked card
                                                var ID = $(this).data('uuid');
                                                var group = $(this).data('group');
                                                var website = $(this).data('website');
                                                var username = $(this).data('username');
                                                var password = $(this).data('password');
                                                var websiteurl = $(this).data('websiteurl');
                                                var notes = $(this).data('notes');

                                                // Set data inside modal
                                                $('#viewAccountPasswordId').val(ID);
                                                $('#viewAccountPasswordGroupValue').val(group);
                                                $('#viewAccountPasswordAccountName').val(website);
                                                $('#viewAccountPasswordUsername').val(username);
                                                $('#viewAccountPasswordPassword').val(password);
                                                $('#viewAccountPasswordUrl').val(websiteurl);
                                                $('#viewAccountPasswordNotes').val(notes);

                                                // Show the modal
                                                $('#passwordModal').modal('show');
                                            });
                                        });

                                    });
                                } else {
                                    console.error("Error:", data.message);
                                }
                            })
                            .catch(error => console.error('Fetch Error:', error));
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                }
            });
        });


        var editAccountPassword = document.getElementById("editAccountPassword");
        var viewAccountPassword = document.getElementById("viewAccountPassword");
        var editAccountPasswordBtn = document.getElementById("editAccountPasswordBtn");
        var saveAccountPasswordBtn = document.getElementById("saveAccountPasswordBtn");

        $('#editAccountPasswordBtn').click(function () {
            $('#editAccountPassword').show();
            $('#viewAccountPassword').hide();
            $('#editAccountPasswordBtn').hide();
            $('#saveAccountPasswordBtn').show();

            $('#editAccountPasswordId').val($('#viewAccountPasswordId').val());
            $('#group').val($('#viewAccountPasswordGroupValue').val()).trigger('change');
            $('#editAccountPasswordAccountName').val($('#viewAccountPasswordAccountName').val());
            $('#editAccountPasswordUsername').val($('#viewAccountPasswordUsername').val());
            $('#editAccountPasswordPassword').val($('#viewAccountPasswordPassword').val());
            $('#editAccountPasswordUrl').val($('#viewAccountPasswordUrl').val());
            $('#editAccountPasswordNotes').val($('#viewAccountPasswordNotes').val());

        });

        // Save edited account password details
        $('#saveAccountPasswordBtn').click(function () {

            // Get form data
            var formData = {
                group: $('#group').val(),
                newGroup: $('#newGroup').val(),
                AccountName: $('#editAccountPasswordAccountName').val(),
                Username: $('#editAccountPasswordUsername').val(),
                Password: $('#editAccountPasswordPassword').val(),
                Url: $('#editAccountPasswordUrl').val(),
                Notes: $('#editAccountPasswordNotes').val(),
                ID: $('#editAccountPasswordId').val(),
                saveEditedAccount: true,
            };
            console.log(formData);
            $.ajax({
                type: 'POST',
                url: 'API/save_account_password.php',
                data: formData,
                dataType: 'json',
                success: function (response) {
                    if (response.success) {

                        /*
                        // Log event to Database
                        $.ajax({
                            url: 'API/log_event.php',
                            type: 'POST',
                            data: {
                                action: 'EDIT_PASSWORD',
                                details: `Edited password/account for account ID ${formData.ID}`
                            }
                        });
                        */

                        if (response.message == 'saveEditAccount=true') {
                            // Show success message in the modal
                            $('#editAccountPasswordInfoMessage').removeClass('alert-danger').addClass('alert-success').html('Account details saved successfully.').show();

                            $('#editAccountPassword').hide();
                            $('#viewAccountPassword').show();
                            $('#editAccountPasswordBtn').show();
                            $('#saveAccountPasswordBtn').hide();

                            setTimeout(function () {
                                $('#editAccountPasswordInfoMessage').hide();

                                $('#viewAccountPasswordGroupValue').val(formData.group).trigger('change');
                                $('#viewAccountPasswordAccountName').val(formData.AccountName);
                                $('#viewAccountPasswordUsername').val(formData.Username);
                                $('#viewAccountPasswordPassword').val(formData.Password);
                                $('#viewAccountPasswordUrl').val(formData.Url);
                                $('#viewAccountPasswordNotes').val(formData.Notes);

                                let card = $(`.password-card[data-uuid="${formData.ID}"]`);
                                let selectedFilterGroup = $('#filterGroup').val();
                                let newGroupName = formData.newGroup.trim();

                                // Update card attributes
                                card.attr('data-uuid', formData.ID);
                                if (newGroupName !== "") {
                                    card.attr('data-group', formData.newGroup);
                                } else {
                                    card.attr('data-group', formData.group);
                                }
                                card.attr('data-website', formData.AccountName);
                                card.attr('data-username', formData.Username);
                                card.attr('data-password', formData.Password);
                                card.attr('data-websiteurl', formData.Url);
                                card.attr('data-notes', formData.Notes);

                                // Also update jQuery's cached data properties
                                card.data('ID', formData.ID);
                                if (newGroupName !== "") {
                                    card.data('group', formData.newGroup);
                                } else {
                                    card.data('group', formData.group);
                                }
                                card.data('website', formData.AccountName);
                                card.data('username', formData.Username);
                                card.data('password', formData.Password);
                                card.data('websiteurl', formData.Url);
                                card.data('notes', formData.Notes);


                                // Update card content
                                card.find('.password-Appname-title').html(`<b>${formData.AccountName}</b>`);
                                card.find('.password-account-username').text(`User Name: ${formData.Username}`);

                                // **Update passwordData.data[]**
                                let itemIndex = passwordData.data.findIndex(item => item.ID == formData.ID);
                                if (itemIndex !== -1) {
                                    passwordData.data[itemIndex].ID = formData.ID;
                                    passwordData.data[itemIndex].GroupName = formData.group;
                                    passwordData.data[itemIndex].AppName = formData.AccountName;
                                    passwordData.data[itemIndex].UserName = formData.Username;
                                    passwordData.data[itemIndex].Password = formData.Password;
                                    passwordData.data[itemIndex].WebsiteUrl = formData.Url;
                                    passwordData.data[itemIndex].Notes = formData.Notes;
                                }

                                // **Update the dropdowns with new group if applicable**
                                if (newGroupName !== "") {
                                    let groupDropdown = $('#filterGroup');
                                    let editGroupDropdown = $('#group');

                                    // Check if the new group already exists
                                    if (groupDropdown.find(`option[value="${newGroupName}"]`).length === 0) {
                                        let newOption = `<option value="${newGroupName}">${newGroupName}</option>`;

                                        // Add to filter dropdown
                                        groupDropdown.append(newOption);

                                        // Add to edit modal group dropdown
                                        editGroupDropdown.append(newOption);
                                    }
                                }

                                // Apply filter again to hide/show the updated card
                                filterPasswords();

                                console.log("Account details saved successfully.");

                            }, 2000);
                        }
                    } else {
                        // Show error message in the modal
                        $('#editAccountPasswordInfoMessage').removeClass('alert-success').addClass('alert-danger').html('Error saving account details.').show();
                        console.log(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                }
            });
        });

        // Add New Account Password
        $('#addNewPasswordBtn').click(function () {
            // Get form data
            var formData = {
                group: $('#addNewGroup').val(),
                newGroup: $('#addNewGroupCreate').val(),
                AccountName: $('#addNewAccountName').val(),
                Username: $('#addNewUsername').val(),
                Password: $('#addNewPassword').val(),
                Url: $('#addNewPasswordUrl').val(),
                Notes: $('#addNewPasswordNotes').val(),
                saveNewAccount: true,
            };
            console.log("New Account's Details to save:");
            console.log(formData);
            $.ajax({
                type: 'POST',
                url: 'API/save_account_password.php',
                data: formData,
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        if (response.message == 'addNewAccount=true') {
                            // Create the new password object
                            let newPassword = {
                                ID: response.id,  // Assuming the API returns the new ID
                                group: formData.newGroup ? formData.newGroup : formData.group,
                                AccountName: formData.AccountName,
                                Username: formData.Username,
                                Password: formData.Password,
                                Url: formData.Url,
                                Notes: formData.Notes
                            };

                            // Add to passwordData.data
                            passwordData.data.push(newPassword);

                            // Create a new password card
                            let newCard = `
                                            <div class="password-card p-3 mb-3" 
                                                data-uuid="${newPassword.ID}"
                                                data-group="${newPassword.group}" 
                                                data-website="${newPassword.AccountName}" 
                                                data-username="${newPassword.Username}" 
                                                data-password="${newPassword.Password}" 
                                                data-websiteurl="${newPassword.Url}" 
                                                data-notes="${newPassword.Notes}">
                                                            
                                                <h5 class="password-Appname-title"><b>${newPassword.AccountName}</b></h5>
                                                <p class="text-muted password-account-username">User Name: ${newPassword.Username}</p>
                                            </div>
                                        `;

                            // Append the new card only if it's in the current filter group
                            if ($("#filterGroup").val() === "all" || $("#filterGroup").val() === newPassword.group) {
                                $("#passwords").append(newCard);
                            }

                            // Add new group to filter dropdown and edit modal select if needed
                            let groupToAdd = newPassword.group;
                            if ($(`#filterGroup option[value="${groupToAdd}"]`).length === 0) {
                                $("#filterGroup, #editAccountPasswordGroup").append(
                                    `<option value="${groupToAdd}">${groupToAdd}</option>`
                                );
                            }

                            $(document).on("click", ".password-card", function () {
                                let card = $(this);

                                var ID = $(this).data('uuid');
                                var group = $(this).data('group');
                                var website = $(this).data('website');
                                var username = $(this).data('username');
                                var password = $(this).data('password');
                                var websiteurl = $(this).data('websiteurl');
                                var notes = $(this).data('notes');

                                // Set data inside modal
                                $('#viewAccountPasswordId').val(ID);
                                $('#viewAccountPasswordGroupValue').val(group);
                                $('#viewAccountPasswordAccountName').val(website);
                                $('#viewAccountPasswordUsername').val(username);
                                $('#viewAccountPasswordPassword').val(password);
                                $('#viewAccountPasswordUrl').val(websiteurl);
                                $('#viewAccountPasswordNotes').val(notes);


                                $("#passwordModal").modal("show");
                            });

                            // Show success message
                            $('#addNewAccountPasswordInfoMessage').removeClass('alert-danger').addClass('alert-success').html('New Account added successfully.').show();

                            setTimeout(function () {
                                $('#addNewAccountPasswordInfoMessage').hide();

                                $('#addNewGroup').val("");
                                $('#addNewGroupCreate').val("");
                                $('#addNewAccountName').val("");
                                $('#addNewUsername').val("");
                                $('#addNewPassword').val("");
                                $('#addNewPasswordUrl').val("");
                                $('#addNewPasswordNotes').val("");

                            }, 2000);
                            console.log("New Account added successfully.");
                        }
                    } else {
                        // Show error message in the modal
                        $('#addNewAccountPasswordInfoMessage').removeClass('alert-success').addClass('alert-danger').html('Error adding new account.').show();
                        console.log(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                }
            });
        });

        // Delete Account/Password
        $('#deleteAccountPasswordBtn').click(function () {
            // Get form data
            var formDeleteData = {
                ID: $('#viewAccountPasswordId').val(),
                deleteAccountPassword: true,
            };
            console.log("Account/Password to be deleted with ID:");
            console.log(formDeleteData);
            $.ajax({
                type: 'POST',
                url: 'API/delete_account_password.php',
                data: formDeleteData,
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        if (response.message == 'deleteAccountPassword=success') {

                            // Remove the password card from the DOM
                            $(`.password-card[data-uuid="${formDeleteData.ID}"]`).remove();

                            // Remove from passwordData.data
                            passwordData.data = passwordData.data.filter(item => item.ID !== formDeleteData.ID);

                            $('#editAccountPassword').hide();
                            $('#viewAccountPassword').show();
                            $('#editAccountPasswordBtn').show();
                            $('#saveAccountPasswordBtn').hide();

                            // Show success message in the modal
                            $('#deleteAccountPasswordInfoMessage').removeClass('alert-danger').addClass('alert-success').html('Deleted Account/Password successfully.').show();

                            setTimeout(function () {
                                $('#deleteAccountPasswordInfoMessage').hide();
                                // Close the modal
                                $('#passwordModal').modal('hide');
                            }, 2000);
                            console.log("Deleted Account/Password successfully.");
                        }
                    } else {
                        // Show error message in the modal
                        $('#deleteAccountPasswordInfoMessage').removeClass('alert-success').addClass('alert-danger').html('Error deleting account/password.').show();
                        console.log(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                }
            });
        });

        // Filter passwords by group
        function filterPasswords() {
            const selectedGroup = document.getElementById("filterGroup").value;
            const cards = document.querySelectorAll(".password-card");

            cards.forEach(card => {
                if (selectedGroup === "all" || card.dataset.group === selectedGroup) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });
        }

        // Show/Hide new group input for edit password modal
        $('#group').change(function () {
            if ($(this).val() === 'new') {
                $('#newGroup').removeClass('d-none');
            } else {
                $('#newGroup').addClass('d-none');
            }
        });

        // Show/Hide new group input for add password modal
        $('#addNewGroup').change(function () {
            if ($(this).val() === 'new') {
                $('#addNewGroupCreate').removeClass('d-none');
            } else {
                $('#addNewGroupCreate').addClass('d-none');
            }
        });

        // Toggle password visibility for add new password
        $('#togglePasswordForAddNewPassword').click(function () {
            const passwordField = $('#addNewPassword');
            const type = passwordField.attr('type') === 'password' ? 'text' : 'password';
            passwordField.attr('type', type);
            $(this).find('i').toggleClass('fa-eye fa-eye-slash');
        });

        // Toggle password visibility for view password
        $("#togglePasswordForView").click(function () {
            let passwordField = $("#viewAccountPasswordPassword");
            let type = passwordField.attr("type") === "password" ? "text" : "password";
            passwordField.attr("type", type);
            $(this).find("i").toggleClass("fa-eye fa-eye-slash");
        });

        // Toggle password visibility for Edit password
        $("#togglePasswordForEdit").click(function () {
            let passwordField = $("#editAccountPasswordPassword");
            let type = passwordField.attr("type") === "password" ? "text" : "password";
            passwordField.attr("type", type);
            $(this).find("i").toggleClass("fa-eye fa-eye-slash");
        });

        // Copy password to clipboard
        $("#copyPassword").click(function () {
            let passwordField = $("#viewAccountPasswordPassword");
            let password = passwordField.val();
            var button = document.getElementById('copyPassword');

            if (password) {
                navigator.clipboard.writeText(password).then(() => {
                    // Initialize the popover
                    var popover = new bootstrap.Popover(button, {
                        trigger: 'manual',
                        placement: 'bottom',
                        content: 'Password copied to clipboard!',
                    });

                    popover.show();

                    setTimeout(function () {
                        popover.hide();
                        popover.dispose();
                    }, 2000);

                    console.log("Password copied to clipboard!");
                }).catch(err => {
                    console.error("Error copying text: ", err);
                });
            }
        });

        // clear fields in edit accounts password modal before closing
        $('#passwordModal').on('hidden.bs.modal', function () {
            $(this).find('#editAccountPassword').find('input, textarea, select').val('');
            // Hide Edit section and only show view section
            $('#editAccountPassword').hide();
            $('#viewAccountPassword').show();
            $('#editAccountPasswordBtn').show();
            $('#saveAccountPasswordBtn').hide();
        });

        // clear fields in Add new account password modal before closing
        $('#addPasswordModal').on('hidden.bs.modal', function () {
            $(this).find('#addNewAccountPassword').find('input, textarea, select').val('');
        });

        // Open URL in a new tab
        $("#launchUrl").click(function () {
            let url = $("#viewAccountPasswordUrl").val().trim();

            if (url) {
                // Ensure the URL has a proper scheme (http or https)
                if (!url.startsWith("http://") && !url.startsWith("https://")) {
                    url = "https://" + url; // Default to HTTPS
                }

                window.open(url, "_blank");
            }
        });

        $(document).ready(function () {
            $('[data-toggle="SharePopover"]').popover({
                trigger: 'hover'
            });
        });

        // Search passwords
        function searchPasswords() {
            const searchValue = document.getElementById("searchInput").value.toLowerCase();
            const cards = document.querySelectorAll(".password-card");

            cards.forEach(card => {
                const searchAppname = card.querySelector(".password-Appname-title").textContent.toLowerCase();
                const searchUsername = card.querySelector(".password-account-username").textContent.toLowerCase();

                if (searchAppname.includes(searchValue)) {
                    card.style.display = "block";
                } else if (searchUsername.includes(searchValue)) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });
        }

        $(document).ready(function () {
            $("#toggleGeneratePasswordForAddNewPassword").click(function (e) {
                e.preventDefault();
                $("#passwordGeneratorModal").modal("show");
            });

            $("#toggleGeneratePasswordForEdit").click(function (e) {
                e.preventDefault();
                $("#passwordGeneratorModal").modal("show");
            });

            // Ensure the second modal backdrop is on top
            $('#passwordGeneratorModal').on('shown.bs.modal', function () {
                $('.modal-backdrop').last().css('z-index', 1051);
                $('#passwordGeneratorModal').css('z-index', 1052);
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const passwordInput = document.getElementById("password");
            const useButton = document.getElementById("usePasswordButton");
            const copyButton = document.getElementById("copyToClipboardButton");
            const generateBtn = document.getElementById("generateButton");
            const message = document.getElementById("message");

            const toggleOptionButtons = document.querySelectorAll(".toggle-option");

            // Toggle visual state of button groups
            toggleOptionButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    const input = btn.querySelector("input[type='checkbox']");
                    input.checked = !input.checked;
                    btn.classList.toggle("active", input.checked);
                });
            });

            const passwordParameters = document.getElementById("passwordParameters");
            const passphraseParameters = document.getElementById("passphraseParameters");

            document.querySelectorAll('input[name="mode"]').forEach((radio) => {
                radio.addEventListener('click', function () {
                    if (this.checked && this.id === 'togglePassphrase') {
                        passphraseParameters.style.display = "block";
                        passwordParameters.style.display = "none";
                    }
                    if (this.checked && this.id === 'togglePassword') {
                        passwordParameters.style.display = "block";
                        passphraseParameters.style.display = "none";
                    }
                });
            });

            const lengthInput = document.getElementById("length");
            const lengthText = document.getElementById("lengthText");
            document.getElementById("incrementLength").onclick = () => { lengthInput.stepUp(); lengthText.value = lengthInput.value; };
            document.getElementById("decrementLength").onclick = () => { lengthInput.stepDown(); lengthText.value = lengthInput.value; };
            lengthInput.oninput = () => { lengthText.value = lengthInput.value; };
            lengthText.onchange = () => {
                const val = parseInt(lengthText.value);
                if (val >= 6 && val <= 255) lengthInput.value = val;
                else lengthText.value = lengthInput.value;
            };

            generateBtn.onclick = () => {
                const isPassphrase = document.getElementById("togglePassphrase").checked;
                const result = isPassphrase ? generatePassphrase() : generatePassword();
                passwordInput.value = result;
                copyButton.disabled = !result;
                useButton.disabled = !result;
                message.innerText = "";
            };

            function generatePassword() {
                const len = +lengthInput.value;
                const sets = [];
                if (document.getElementById("uppercase").checked) sets.push("ABCDEFGHIJKLMNOPQRSTUVWXYZ");
                if (document.getElementById("lowercase").checked) sets.push("abcdefghijklmnopqrstuvwxyz");
                if (document.getElementById("numbers").checked) sets.push("0123456789");
                if (document.getElementById("special").checked) sets.push("!@#$%?-_+=&*");

                if (sets.length === 0) {
                    message.innerText = "Select at least one character set.";
                    return "";
                }

                const chars = sets.join("");
                let pass = "";
                for (let i = 0; i < len; i++) {
                    pass += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return pass;
            }

            function generatePassphrase() {
                const wordList = ["apple", "banana", "cat", "dog", "elephant", "fish", "grape", "hat", "ice", "jelly"];
                const words = parseInt(document.getElementById("words").value);
                const useSeparator = document.getElementById("separator").checked;
                const includeNumbers = document.getElementById("includeNumbers").checked;
                const capitalize = document.getElementById("capitalize").checked;

                let result = [];
                for (let i = 0; i < words; i++) {
                    let word = wordList[Math.floor(Math.random() * wordList.length)];
                    if (capitalize) word = word.charAt(0).toUpperCase() + word.slice(1);
                    result.push(word);
                }

                if (includeNumbers) result.push(Math.floor(Math.random() * 10000));
                return result.join(useSeparator ? "-" : "");
            }

            const clipboard = new ClipboardJS(copyButton);
            clipboard.on("success", () => {
                message.innerText = "Copied!";
            });

            useButton.addEventListener("click", function () {
                const generated = passwordInput.value.trim();
                if (!generated) return;

                const targetInput = document.getElementById("addNewPassword");
                if (targetInput) {
                    targetInput.value = generated;
                    $('#passwordGeneratorModal').modal('hide');
                } else {
                    message.innerText = "Target input field not found.";
                }
            });

        });

        $(document).ready(function () {
            $("#shareAccountPasswordToggleBtn").click(function (e) {
                e.preventDefault();
                const currentId = $("#viewAccountPasswordId").val();
                $("#sharePasswordId").val(currentId);
                $("#sharePasswordModal").modal("show");
            });


            // Ensure the second modal backdrop is on top
            $('#sharePasswordModal').on('shown.bs.modal', function () {
                $('.modal-backdrop').last().css('z-index', 1051);
                $('#sharePasswordModal').css('z-index', 1052);
            });
        });











        // Internal sharing
        function shareInternally() {
            const email = $('#internalEmail').val().trim();
            const passwordId = $('#sharePasswordId').val();

            if (!email) {
                alert("Enter a user email.");
                return;
            }

            $.ajax({
                url: 'API/share_password.php',
                method: 'POST',
                data: {
                    type: 'internal',
                    email: email,
                    passwordId: passwordId,
                    vaultType: 'password'
                },
                success: function (res) {
                    alert("Password shared internally!");
                    $('#sharePasswordModal').modal('hide');
                    $(`.password-card[data-uuid="${passwordId}"]`).find(".password-Appname-title").append(`<span class="d-inline-block" tabindex="0" data-toggle="SharePopover" data-placement="top" data-content="You are sharing this account with others.">&nbsp&nbsp<i class="fa-solid fa-users"></i></span>`);
                    $('[data-toggle="SharePopover"]').popover({ trigger: 'hover' });
                    /*
                    $.post('API/log_event.php', {
                        action: 'SHARE_PASSWORD',
                        details: `Password ID ${passwordId} shared ${type === 'internal' ? 'internally' : 'externally'}`
                    });
                    */
                },
                error: function (err) {
                    alert("Error sharing internally.");
                }
            });
        }

        // Allowed email extensions
        const allowedExtensions = ['.com', '.net', '.org', '.co', '.us', '.in'];

        function isValidEmail(email) {
            // Basic email regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return false;

            // Get the extension (domain + tld)
            const extension = email.substring(email.lastIndexOf('.'));
            return allowedExtensions.includes(extension.toLowerCase());
        }

        // Email availability check
        $('#internalEmail').on('input', function () {
            const email = $(this).val().trim();
            $('#emailCheckMessage').text('');
            $('#shareInternalBtn').prop('disabled', true);

            // Only run check if full email with extension is present and valid
            if (isValidEmail(email)) {
                // Show a loader/message if you want, e.g. "Checking user..."
                $('#emailCheckMessage').text('Checking user...').css('color', 'grey');
                $.post('API/check_user_email.php', { email }, function (res) {
                    if (res.exists) {
                        $('#emailCheckMessage').text('User found.').css('color', 'green');
                        $('#shareInternalBtn').prop('disabled', false);
                    } else {
                        $('#emailCheckMessage').text('No such user found.').css('color', 'red');
                    }
                }, 'json');
            } else if (email.length > 0) {
                $('#emailCheckMessage').text('Enter a valid email address (e.g. user@example.com)').css('color', 'red');
            }
        });

        // External fields toggle
        function toggleExternalShareFields() {
            $('#externalShareFields').slideToggle();
        }

        $('#noExpiryCheckbox').change(function () {
            $('#expiryFields').toggle(!this.checked);
        });

        // External sharing with expiry
        function shareExternally() {
            const passwordId = $('#viewAccountPasswordId').val();
            const noExpiry = $('#noExpiryCheckbox').is(':checked');
            let expiry = null;

            if (!noExpiry) {
                const date = $('#expiryDate').val();
                const time = $('#expiryTime').val();
                if (!date || !time) return alert('Please select date and time or choose no-expiry.');

                expiry = `${date} ${time}`;
            }

            $.post('API/share_password.php', {
                type: 'external',
                passwordId,
                noExpiry,
                expiry,
                vaultType: 'password'
            }, function (res) {
                if (res.share_uuid) {
                    const link = `${window.location.origin}/external_share_viewer.html?share_uuid=${res.share_uuid}`;
                    $('#externalShareLink').val(link).show();
                    $('#copyExternalLink').show();
                    $(`.password-card[data-uuid="${passwordId}"]`).find(".password-Appname-title").append(`<span class="d-inline-block" tabindex="0" data-toggle="SharePopover" data-placement="top" data-content="You are sharing this account with others.">&nbsp&nbsp<i class="fa-solid fa-users"></i></span>`);
                    $('[data-toggle="SharePopover"]').popover({ trigger: 'hover' });
                    /*
                    $.post('API/log_event.php', {
                        action: 'SHARE_PASSWORD',
                        details: `Password ID ${passwordId} shared ${type === 'internal' ? 'internally' : 'externally'}`
                    });
                    */
                }
            }, 'json');
        }

        // Copy external link
        $('#copyExternalLink').click(function () {
            const url = $('#externalShareLink').val();
            navigator.clipboard.writeText(url).then(() => {
                alert('URL copied to clipboard!');
            });
        });


    </script>
</body>

</html>